# Presidium Authentication Architecture v8.4

## üìã –û–±–∑–æ—Ä

Presidium –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é** —Å SMS-OTP –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–º —Ñ–∞–∫—Ç–æ—Ä–æ–º, –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—É—é device binding, –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ roadmap –∫ WebAuthn/passkeys.

## üîê –§–∞–∫—Ç–æ—Ä—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 1. SMS-OTP (–ü–µ—Ä–≤–∏—á–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä)
- ‚úÖ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
- ‚úÖ –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 90 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
- ‚úÖ Rate limiting: 3 –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–∏–Ω—É—Ç—É

### 2. Device Fingerprinting (Device Binding)
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: User-Agent, Screen Resolution, Timezone, Platform, WebGL, Canvas
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–≤–µ—Ä–∏–µ –∫ –∏–∑–≤–µ—Å—Ç–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º

### 3. –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- ‚úÖ **Typing Entropy**: –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
- ‚úÖ **Velocity Checks**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **Consistency**: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

### 4. Rate Limiting
- ‚úÖ OTP requests: 3/–º–∏–Ω—É—Ç—É
- ‚úÖ OTP verify: 5/5 –º–∏–Ω—É—Ç
- ‚úÖ Login attempts: 5/15 –º–∏–Ω—É—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

### 5. Risk Scoring
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–∞ 0-100
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ risk >= 80
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π MFA –ø—Ä–∏ risk >= 50

## üöÄ Flow –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞—Ü–∏—è
```
POST /api/auth/initiate
{
  "phone": "+79991234567",
  "deviceFingerprint": "fp_abc123...",
  "deviceComponents": {
    "userAgent": "...",
    "screenResolution": "1920x1080",
    "timezone": "Europe/Moscow",
    ...
  },
  "typingPattern": { ... }, // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "captchaToken": "..." // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "requiresOTP": true,
  "otpSent": true,
  "otpId": "uuid",
  "riskScore": 25,
  "blocked": false,
  "nextStep": "verify_otp"
}
```

### –®–∞–≥ 2: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è OTP
```
POST /api/auth/verify-otp
{
  "otpId": "uuid",
  "code": "123456",
  "phone": "+79991234567",
  "deviceFingerprint": "fp_abc123..."
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "sessionId": "session_uuid",
  "token": "jwt_token",
  "expiresAt": "2024-01-08T00:00:00Z",
  "requiresMFA": false
}
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Device Fingerprinting
- –°–æ–±–∏—Ä–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±—Ä–∞—É–∑–µ—Ä–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π fingerprint
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–µ—Ä–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: risk +30
- –ò–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: risk -10

### Typing Pattern Analysis
- **WPM** (Words Per Minute): —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–±–æ—Ä–∞
- **Entropy**: —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –º–µ–∂–¥—É –Ω–∞–∂–∞—Ç–∏—è–º–∏
- **Consistency**: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ
- –ë–æ—Ç-–¥–µ—Ç–µ–∫—Ü–∏—è: –Ω–∏–∑–∫–∞—è —ç–Ω—Ç—Ä–æ–ø–∏—è, —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

### Risk Scoring
```
–ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: 0-100

+30 - –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
+20 - –Ω–∏–∑–∫–∞—è typing entropy (< 2.0)
+40 - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π User-Agent (bot/crawler)
+15 - –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (> 30%)
+40 - —Å–∫–æ—Ä–æ—Å—Ç—å > 200 WPM
+15 - —Å–∫–æ—Ä–æ—Å—Ç—å < 10 WPM

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: risk >= 80
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π MFA: risk >= 50
```

### Rate Limiting
```
OTP Request:
  - 3 –∑–∞–ø—Ä–æ—Å–∞ / –º–∏–Ω—É—Ç—É
  - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 2 –º–∏–Ω—É—Ç—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

OTP Verify:
  - 5 –ø–æ–ø—ã—Ç–æ–∫ / 5 –º–∏–Ω—É—Ç
  - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 25 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

Login Attempt:
  - 5 –ø–æ–ø—ã—Ç–æ–∫ / 15 –º–∏–Ω—É—Ç
  - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 75 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
```

## üìä Security Events

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- `failed_login` - –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
- `suspicious_activity` - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- `device_change` - —Å–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `location_change` - —Å–º–µ–Ω–∞ –ª–æ–∫–∞—Ü–∏–∏
- `rate_limit_exceeded` - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ rate limit

## üîÆ Roadmap –∫ WebAuthn/Passkeys

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (v8.4)
- ‚úÖ SMS-OTP –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä
- ‚úÖ Device binding
- ‚úÖ –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- ‚úÖ Rate limiting

### –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è (v9.0+)
- üîÑ WebAuthn/FIDO2 –¥–ª—è –≤—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üîÑ TOTP-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Google Authenticator, Authy)
- üîÑ –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (fingerprint, face ID)
- üîÑ –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ (YubiKey, Titan)
- üîÑ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

## üìù API Endpoints

### POST `/api/auth/initiate`
–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ SMS OTP)

### POST `/api/auth/verify-otp`
–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è SMS OTP –∫–æ–¥–∞

### GET `/api/auth/session/:sessionId`
–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏

### POST `/api/auth/logout`
–û—Ç–∑—ã–≤ —Å–µ—Å—Å–∏–∏

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### SMS-OTP
```typescript
{
  codeLength: 6,
  expiresIn: 90000, // 90 —Å–µ–∫—É–Ω–¥
  maxAttempts: 3,
  rateLimit: { maxRequests: 3, windowMs: 60000 }
}
```

### Session
```typescript
{
  expiresIn: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  refreshToken: true // TODO: implement refresh tokens
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Mock —Ä–µ–∂–∏–º
–í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ SMS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å:
```
üì± [MOCK] SMS OTP for +79991234567: 123456
```

### Production
–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π SMS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä —á–µ—Ä–µ–∑ `backend/src/adapters/sms.ts`

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [FIDO2/WebAuthn Specification](https://www.w3.org/TR/webauthn-2/)
- [NIST Digital Identity Guidelines](https://pages.nist.gov/800-63-3/)

